# R2. Ревью кода — Rob Pike

> **Ветка:** devel -> master
> **Коммиты:** Add backend API, Add frontend, Add vt

## Общее впечатление

Код написан достаточно просто и понятно, что хорошо. Разделение на пакеты логичное. Однако есть места, которые можно упростить, убрать дублирование и сделать код более идиоматичным для Go.

## Что можно улучшить и упростить

### 1. [medium] Дублирование подсчёта IssueStats в rest.go

**Файл:** `pkg/rest/rest.go:91-97`

В `notifySlack` вручную суммируются `Critical`, `High`, `Medium`, `Low` из review files. Эта же логика уже есть в `reviewer.IssueStats.Add()` и вычисляется в `prepareReview`. Общая статистика уже доступна в `rv.TrafficLight`, но не в виде отдельной структуры. Лучше вычислять суммарную статистику один раз при `prepareReview` и хранить её в `Review`, а не пересчитывать в каждом потребителе.

```go
// Текущий код в rest.go — дублирование:
var stats slack.IssueStats
for _, rf := range rv.ReviewFiles {
    stats.Critical += rf.IssueStats.Critical
    stats.High += rf.IssueStats.High
    stats.Medium += rf.IssueStats.Medium
    stats.Low += rf.IssueStats.Low
}
```

**Рекомендация:** сохранять суммарную `IssueStats` в структуре `Review` при создании, использовать повсюду.

### 2. [medium] Дублирование типа IssueStats в трёх пакетах

**Файлы:** `pkg/reviewer/model.go:139`, `pkg/rpc/model.go:11-17`, `pkg/slack/slack.go:30-35`

Структура `IssueStats` определена трижды — в `reviewer`, `rpc` и `slack` пакетах. Каждая содержит одни и те же поля `Critical`, `High`, `Medium`, `Low`. Это типичное нарушение DRY. Пакет `slack` мог бы принимать `reviewer.IssueStats` или использовать общий интерфейс.

**Рекомендация:** использовать один тип из domain-слоя (`reviewer.IssueStats`) или `db.ReviewFileIssueStats` в Slack-нотификаторе.

### 3. [low] GetUploadScript парсит шаблон при каждом запросе

**Файл:** `pkg/rest/rest.go:152-163`

Шаблон `uploadScriptTmpl` парсится при каждом вызове `GetUploadScript`. Шаблон статичен и не меняется — достаточно распарсить его один раз при инициализации `Handler`.

```go
func (h *Handler) GetUploadScript(c echo.Context) error {
    tmpl, err := template.New("upload.js").Parse(uploadScriptTmpl) // парсинг каждый раз
    // ...
}
```

**Рекомендация:** распарсить шаблон в конструкторе `NewHandler` или использовать `template.Must` на уровне пакета.

### 4. [low] Неиспользуемый FilterBar.vue

**Файл:** `frontend/src/components/FilterBar.vue`

Компонент `FilterBar.vue` определён (5 строк — просто обёртка со `<slot />`), но нигде не импортируется и не используется. Мёртвый код.

**Рекомендация:** удалить или начать использовать.

### 5. [low] ReviewsPage загружает все проекты для одного

**Файл:** `frontend/src/pages/ReviewsPage.vue:155`

В `loadInitial` вызывается `api.review.projects()`, чтобы найти один проект по ID:

```typescript
const [projects, items, count] = await Promise.all([
    api.review.projects(),  // загружает ВСЕ проекты
    api.review.get(projectId, buildFilters()),
    api.review.count(projectId, buildFilters()),
])
project.value = projects.find(p => p.projectId === projectId) ?? null
```

Загружаются все проекты только для получения title одного. При росте количества проектов это неэффективно. Нужен отдельный RPC-метод `review.GetProject(projectId)` или включение информации о проекте в ответ `review.Get`.

### 6. [low] Лишний двойной `await nextTick()` в ReviewPage

**Файл:** `frontend/src/pages/ReviewPage.vue:374-376`

```typescript
await nextTick()
await nextTick()
```

Два `nextTick` подряд — это хак для ожидания рендеринга HeadlessUI TabPanel. Хрупко и может сломаться при обновлении библиотеки.

**Рекомендация:** использовать `MutationObserver` или `requestAnimationFrame` для надёжного ожидания DOM-элементов.

### 7. [low] Два отдельных вызова `buildFilters()` в ReviewsPage

**Файл:** `frontend/src/pages/ReviewsPage.vue:153-157`

```typescript
const [projects, items, count] = await Promise.all([
    api.review.projects(),
    api.review.get(projectId, buildFilters()),    // вызов 1
    api.review.count(projectId, buildFilters()),   // вызов 2
])
```

`buildFilters()` вызывается дважды, создавая два объекта. Не ошибка, но лучше сохранить результат в переменную:

```typescript
const f = buildFilters()
const [projects, items, count] = await Promise.all([...])
```

### 8. [low] Нейминг: `Get` вместо `List` в RPC ReviewService

**Файл:** `pkg/rpc/review.go:85`

Метод `Get` возвращает список `[]ReviewSummary`. В Go-конвенциях `Get` обычно означает получение одной сущности, а `List` — списка. Это может сбить с толку при чтении API-документации.

**Рекомендация:** переименовать в `List` или `ListReviews`.

## Вывод

Код хорошо структурирован. Основные рекомендации: убрать дублирование `IssueStats`, кешировать парсинг шаблона, добавить RPC-метод для получения одного проекта, привести нейминг API-методов к Go-конвенциям. Все замечания — улучшения, не критические проблемы.
