# R4. Ревью тестов — Mitchell Hashimoto

> **Ветка:** devel -> master
> **Коммиты:** Add backend API, Add frontend, Add vt

## Обзор тестового покрытия

В MR добавлены тесты в пакете `pkg/reviewer/`:

| Файл | Что тестирует |
|------|--------------|
| `model_test.go` | Unit-тесты: `IsValidReviewType`, `IsValidSeverity`, `calcIssueStats`, `calcTrafficLight`, `IssueStats.Add`, `prepareReview`, `HasSlackWebhook`, `ReviewSearch.ToDB`, `IssueSearch.ToDB` |
| `manager_test.go` | Интеграционные тесты: `CreateReview`, `GetReview`, `ListReviews`, `CountReviews`, `ReviewFileByKey`, `UpdateReviewFileContent`, `ProjectsStats`, `SetFeedback`, `ListIssues`, `CountIssues`, `ListIssuesByProject` |
| `project_test.go` | Интеграционные тесты: `GetByID`, `GetByKey`, `List`, `Prompt` (с шаблоном и подстановкой токена) |
| `init_test.go` | Seed-скрипт для ручной загрузки данных (skipped по умолчанию) |

Также есть test factories в `pkg/db/test/`:
- `common.go` — фабрика `User`
- `project.go` — фабрики `Project`, `Prompt`, `SlackChannel`, `TaskTracker`
- `review.go` — фабрики `Issue`, `ReviewFile`, `Review`

## Что покрыто хорошо

1. **Unit-тесты модели** — table-driven тесты для всех вычислительных функций (`calcIssueStats`, `calcTrafficLight`, `IssueStats.Add`). Покрыты граничные случаи: пустой вход, неизвестные severity, все комбинации traffic light.

2. **prepareReview** — покрыт happy path, дублирование reviewType, пустые review files. Проверяются все side effects: projectID, promptID, statusID, IssueStats, TrafficLight.

3. **ToDB конвертеры** — покрыта конвертация поисковых параметров: nil receiver, полное заполнение, минимальное заполнение, нулевой reviewID.

4. **Интеграционные тесты** — полный CRUD-цикл: создание ревью с файлами и issues, получение, листинг, пагинация, фильтрация, feedback.

5. **Test factories** — хорошо спроектированные фабрики с опциональными параметрами и Cleaner-функциями для очистки.

## Замечания

### 1. [high] Отсутствуют тесты для REST-слоя (pkg/rest)

**Файл:** `pkg/rest/`

Пакет `pkg/rest` содержит критическую бизнес-логику:
- `ReviewDraft.Validate()` — валидация входных данных
- `ReviewDraft.ToModel()` — конвертация в domain model
- `Handler.CreateReview` — HTTP-handler
- `Handler.UploadReviewFile` — HTTP-handler

Ни одна из этих функций не покрыта тестами. `Validate()` и `ToModel()` — чистые функции, легко тестируемые unit-тестами. Это важно, учитывая найденные проблемы с потерей issues при несовпадении `fileType` и `files`.

**Рекомендация:** добавить unit-тесты для `Validate()` и `ToModel()`:
- Валидный ReviewDraft
- ReviewDraft с невалидным reviewType
- ReviewDraft с невалидной severity
- ReviewDraft с issue, чей fileType не совпадает с files (тест на потерю данных)
- ReviewDraft с пустыми обязательными полями
- ToModel: проверить корректную группировку issues по review files

### 2. [high] Отсутствуют тесты для RPC-слоя (pkg/rpc)

**Файл:** `pkg/rpc/`

JSON-RPC сервис `ReviewService` содержит 9 методов, ни один не покрыт тестами. Особенно важны:
- `Feedback` — меняет состояние, нужен тест на авторизацию (несуществующий issue)
- `IssuesByProject` / `CountIssuesByProject` — фильтрация по проекту
- `SetComment` — валидация длины (255 символов)
- Конвертеры `ReviewFilters.ToDomain`, `IssueFilters.ToDomain` — чистые функции

**Рекомендация:** как минимум покрыть конвертеры unit-тестами и добавить интеграционные тесты для `Feedback`, `SetComment`.

### 3. [medium] Отсутствуют тесты для Slack-нотификатора (pkg/slack)

**Файл:** `pkg/slack/slack.go`

`Notifier.Send` отправляет HTTP-запросы к Slack webhook. Нет тестов для:
- Формирования текста уведомления (`ReviewNotification.text()`)
- Обработки ошибок HTTP
- `trafficLightEmoji` — простая функция, но стоит проверить

**Рекомендация:** unit-тесты для `text()` и `trafficLightEmoji()`. Для `Send` — httptest.Server.

### 4. [medium] Тесты createTestReview всегда создают одинаковые данные

**Файл:** `pkg/reviewer/manager_test.go:38-71`

Функция `createTestReview` создаёт ревью с захардкоженными данными:

```go
rv := &Review{
    Review: db.Review{
        Title:        "Test Review",
        ExternalID:   "MR-123",
        // ...
    },
}
```

При создании нескольких ревью в одном тесте (например, `TestReviewManager_ListReviews`) все будут иметь одинаковые title, author, ExternalID. Это:
- Затрудняет отладку при падении тестов
- Не позволяет проверить уникальность фильтрации (например, фильтр по author всегда находит всё)

**Рекомендация:** использовать `gofakeit` (уже в зависимостях) для генерации уникальных данных или принимать параметры.

### 5. [medium] Нет negative-тестов для SetComment

**Файл:** `pkg/rpc/review.go:238-251`

`SetComment` имеет валидацию `len(*comment) > 255`, но нет теста для этого ограничения. Также нет теста на `SetComment` для несуществующего issue.

### 6. [low] Тест TestDBLoad помечен как SkipNow — мёртвый код

**Файл:** `pkg/reviewer/init_test.go:10`

```go
func TestDBLoad(t *testing.T) {
    t.SkipNow()
    // ...
}
```

Тест используется как seed-скрипт и всегда пропускается. Это не настоящий тест, а утилита. Лучше оформить как отдельный скрипт или `cmd/seed/main.go`, чтобы не засорять тестовые отчёты.

### 7. [low] Нет тестов для фронтенда

**Файл:** `frontend/`

Фронтенд (Vue 3 + TypeScript) не содержит ни одного теста. Для первой итерации это понятно, но стоит добавить хотя бы:
- Unit-тесты для `utils/format.ts` (чистые функции: `timeAgo`, `formatDuration`, `compareSeverity`)
- Unit-тесты для `utils/breadcrumbs.ts`

## Покрытие по пакетам

| Пакет | Тесты | Оценка |
|-------|-------|--------|
| `pkg/reviewer` | unit + integration | Хорошо |
| `pkg/rest` | нет | Недостаточно |
| `pkg/rpc` | нет | Недостаточно |
| `pkg/slack` | нет | Недостаточно |
| `pkg/db/test` | factories | Хорошо |
| `pkg/vt` | 1 тест (user) | Минимально |
| `frontend` | нет | Нет покрытия |

## Вывод

Тесты в `pkg/reviewer` хорошо написаны и покрывают основную бизнес-логику. Однако REST-слой, RPC-слой и Slack-нотификатор не покрыты тестами. Учитывая, что REST — точка входа для загрузки ревью, а `Validate()` и `ToModel()` содержат нетривиальную логику конвертации — это критический пробел. Рекомендуется добавить тесты для `pkg/rest` в первую очередь.
