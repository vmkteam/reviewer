# Required CI/CD variables: PROJECT_KEY, ANTHROPIC_API_KEY
claude-code-review:
  image: registry.gitlab/docker/claude-code:latest
  stage: check
  variables:
    GIT_DEPTH: 100
    REVIEWSRV_URL: "{{.BaseURL}}"
  script:
    - git fetch --depth=20 origin {{.TargetBranch}}:{{.TargetBranch}}
    - |
      PROMPT=$(curl -sf "${REVIEWSRV_URL}/v1/prompt/${PROJECT_KEY}/")
      if [ -z "$PROMPT" ]; then echo "Failed to fetch prompt"; exit 1; fi
      PROMPT=$(echo "$PROMPT" | sed \
        -e "s/%SOURCE_BRANCH%/${CI_COMMIT_BRANCH}/g" \
        -e "s/%TARGET_BRANCH%/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}/g" \
        -e "s/%EXTERNAL_ID%/${CI_MERGE_REQUEST_IID}/g" \
        -e "s/%TITLE%/${CI_MERGE_REQUEST_TITLE//\//\\/}/g")
    - |
      claude \
      --model opus \
      --permission-mode acceptEdits \
      --allowedTools "Bash(*) Read(*) Edit(*) Write(*) WebFetch(*)" \
      -p "$PROMPT"
    - curl -sf "${REVIEWSRV_URL}/v1/upload/upload.js" -o upload.js
    - REVIEW_DIR=. node upload.js
    - for f in *.md; do [ -f "$f" ] || continue; o="${f%.md}.html"; { sed '/\{\{BODY\}\}/,$d' review-template.html; npx marked -i "$f"; sed '1,/\{\{BODY\}\}/d' review-template.html; } > "$o"; done
  artifacts:
    paths:
      - "*.html"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "{{.TargetBranch}}" && $CI_MERGE_REQUEST_TITLE !~ /^draft:/i'
      when: manual
      allow_failure: true
    - when: never
